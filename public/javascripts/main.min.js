var app=angular.module("chatApp",["ui.bootstrap","ui.router","ngStorage"]);app.config(["$stateProvider","$urlRouterProvider","$locationProvider",function(e,t,n){t.otherwise("/home"),n.hashPrefix(""),n.html5Mode(!0),e.state("chat",{url:"/chat",templateUrl:"/chat.html",controller:"ChatCtrl"}).state("login",{url:"/login",templateUrl:"/login.html",controller:"AuthCtrl",onEnter:["$state","auth",function(e,t){t.isLoggedIn()&&e.go("chat")}]}).state("register",{url:"/register",templateUrl:"/register.html",controller:"AuthCtrl",onEnter:["$state","auth",function(e,t){t.isLoggedIn()&&e.go("chat")}]}).state("home",{url:"/home",templateUrl:"/home.html"})}]),app.factory("auth",["$http","$window","$state","socket","$localStorage",function(e,t,n,o,r){var a={};return a.saveToken=function(e){t.localStorage["chranslate-token"]=e},a.getToken=function(){return t.localStorage["chranslate-token"]},a.isLoggedIn=function(){var e=a.getToken();return!!e&&JSON.parse(t.atob(e.split(".")[1])).exp>Date.now()/1e3},a.currentUser=function(){if(a.isLoggedIn()){var e=a.getToken();return JSON.parse(t.atob(e.split(".")[1])).username}},a.register=function(t){return e.post("/register",t).success(function(e){a.saveToken(e.token);var t=a.currentUser();o.emit("entered chat",t)})},a.logIn=function(t){return e.post("/login",t).success(function(e){a.saveToken(e.token);var t=a.currentUser();o.emit("entered chat",t)})},a.logOut=function(){var e=a.currentUser();o.emit("remove user",e),t.localStorage.removeItem("chranslate-token"),delete r.messages,delete r.users,delete r.to_user,n.go("login")},a}]),app.factory("socket",["$rootScope",function(e){var t=io.connect({reconnection:!0,reconnectionDelay:1e3,reconnectionDelayMax:5e3,timeout:2e4});return{on:function(n,o){t.on(n,function(){var n=arguments;e.$apply(function(){o.apply(t,n)})})},emit:function(n,o,r){t.emit(n,o,function(){var n=arguments;e.$apply(function(){r&&r.apply(t,n)})})}}}]),app.factory("setLanguage",[function(){var e="en";return{getLanguage:function(){return e},setLanguage:function(t){e=t}}}]),app.controller("NavCtrl",["$scope","auth",function(e,t){e.isLoggedIn=t.isLoggedIn,e.currentUser=t.currentUser,e.logOut=t.logOut}]),app.controller("AuthCtrl",["$scope","$state","auth",function(e,t,n){e.user={},e.register=function(){n.register(e.user).error(function(t){e.error=t}).then(function(){t.go("chat")})},e.logIn=function(){n.logIn(e.user).error(function(t){e.error=t}).then(function(){t.go("chat")})}}]),app.directive("whenScrolled",function(){return function(e,t,n){var o=t[0];t.bind("scroll",function(){o.scrollTop+o.offsetHeight>=o.scrollHeight&&e.$apply(n.whenScrolled)})}}),app.directive("notificationBadge",function(e){return function(t,n,o){e(function(){n.addClass("notification-badge")},0),t.$watch(o.notificationBadge,function(e){e>0?n.attr("data-badge-count",e):n.removeAttr("data-badge-count")})}}),app.controller("DropdownCtrl",["$scope","$log","setLanguage",function(e,t,n){e.options=[{language:"Spanish",shorthand:"es"},{language:"English",shorthand:"en"},{language:"Dutch",shorthand:"nl"},{language:"French",shorthand:"fr"}],e.changeLanguage=function(t){e.selected=t.language,n.setLanguage(t.shorthand)},e.status={isopen:!1},e.toggled=function(e){t.log("Dropdown is now: ",e)},e.toggleDropdown=function(t){t.preventDefault(),t.stopPropagation(),e.status.isopen=!e.status.isopen}}]),app.controller("ChatCtrl",["$scope","socket","$http","$log","setLanguage","auth","$window","$localStorage",function(e,t,n,o,r,a,s,u){e.userMenu="",e.currentUser=a.currentUser,u.messages?e.msgs=u.messages:e.msgs=[],u.users&&(e.usernames=u.users);var c;u.to_user?(e.connectedTo=u.to_user,c=u.to_user):e.connectedTo="Nobody! Click a name in the user list to start a private Chranslation Chat!";var g="";e.activeToggle=function(){""==e.userMenu?e.userMenu="menuDisplayed":e.userMenu=""},e.$watch("msg",function(){n({method:"GET",url:"https://translate.yandex.net/api/v1.5/tr.json/translate?key=trnsl.1.1.20160723T144020Z.0c10deb189f9465d.aad68393900352c2aa9b1632bcacb766fbd107f8&text="+e.msg+"&lang=en-"+r.getLanguage()}).then(function(t){g=t.data,e.output=g.text.toString(),o.info(t)},function(t){e.error=t.data,o.info(t)})}),e.privateChat=function(n){c!=n&&(e.msgs=[]),c=n,u.to_user=c,e.connectedTo=c,0==e.msgs.length&&t.emit("get old msgs",c)},e.loadMore=function(){t.emit("load more msgs",c)},e.sendMsg=function(){if(e.msg&&c){date=new Date;var n={user:a.currentUser(),msg:e.output,date:date};e.msgs.unshift(n),u.messages=e.msgs,t.emit("send msg",{toUser:c,msg:e.output}),e.msg=""}},t.on("get msg",function(t){t.date=new Date,t.user==c?e.msgs.unshift(t):console.log("Not on user");var n=t.user,o=-1;for(i=0;i<=e.usernames.length-1;i++)if(e.usernames[i].name===n){o=i;break}e.usernames[o].count++}),t.on("get users",function(t){var n=t.indexOf(a.currentUser());-1!=n&&t.splice(n,1);var o=t.map(function(e){return{name:e,count:0}});e.usernames=o,u.users=e.usernames}),t.on("load old msgs",function(t){for(i=0;i<=t.length-1;i++)e.msgs.push({user:t[i].username,msg:t[i].msg,date:t[i].created});u.messages=e.msgs})}]);